name: Build and Deploy Wheels

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python version to use'
        required: true
        type: choice
        options:
          - 3.8
          - 3.9
          - 3.10
          - 3.11
          - 3.12
        default: '3.12'
      package_name:
        description: 'Package name to build'
        required: true
        type: choice
        options:
          - numpy
          - scipy
          - shapely
          - google-crc32c
          - grpcio
      package_version:
        description: 'Package version to build'
        required: true

jobs:
  build-wheels:
    runs-on: ubuntu-latest
    name: ${{ matrix.arch }} Build wheel ${{ github.event.inputs.package_name }} ${{ github.event.inputs.package_version }} on Python ${{ github.event.inputs.python_version }}
    strategy:
      matrix:
        arch: [arm64, amd64]
    steps:
      - name: Print input values
        run: |
          echo "Python Version: ${{ github.event.inputs.python_version }}"
          echo "Package Name: ${{ github.event.inputs.package_name }}"
          echo "Package Version: ${{ github.event.inputs.package_version }}"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Package Wheel
        run: |
          cd packages/${{ github.event.inputs.package_name }}
          docker buildx build --platform linux/${{ matrix.arch }} \
          --build-arg PACKAGE_VERSION=${{ github.event.inputs.package_version }} \
          --build-arg PYTHON_VERSION=${{ github.event.inputs.python_version }} \
          -t my-${{ github.event.inputs.package_name }}-builder:latest \
          --output type=local,dest=../../wheels .

      - name: Persist wheels directory
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.arch }}
          path: ./wheels/wheels/*.whl  # Only upload wheel files
          if-no-files-found: warn

  upload-wheels:
    runs-on: ubuntu-latest
    needs: build-wheels
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download wheels artifact
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          merge-multiple: true
          path: ./wheels

      - name: Upload wheels to GitHub Pages
        run: |
          ls -haltR .
          mkdir -p docs/${{ github.event.inputs.package_name }}
          mv -f wheels/* docs/${{ github.event.inputs.package_name }}/
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions"
          git add docs/
          git commit -m "Add wheels for ${{ github.event.inputs.package_name }} ${{ github.event.inputs.package_version }}"
          git pull --rebase origin main  # Pull the latest changes and rebase
          git push

      - name: Update index.html
        run: |
          cd docs/
          # Generate the root index.html
          echo "<html><body><ul>" > index.html
          for package in $(ls -d */); do
            package_name=${package%/}
            echo "<li><a href=\"$package_name/\">$package_name</a></li>" >> index.html
      
            # Generate index.html for each package
            mkdir -p "$package_name"
            echo "<html><body><h1>$package_name</h1><ul>" > "$package_name/index.html"
            for package_file in $(ls "${package_name}/"*.whl 2>/dev/null); do
             # Only include .whl files
              file_name=$(basename "$package_file")
              echo "<li><a href=\"$file_name\">$file_name</a></li>" >> "$package_name/index.html"
            done
            echo "</ul></body></html>" >> "$package_name/index.html"
          done
          echo "</ul></body></html>" >> index.html
      
          git add index.html */index.html
          git commit -m "Update package index files"
          git push
